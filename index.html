import React, { useState, useEffect, useRef } from 'react';
import { Camera, MapPin, User, CheckCircle, List, LogOut, ShieldCheck, AlertTriangle } from 'lucide-react';
import { initializeApp } from 'firebase/app';
// 确保导入 signInWithCustomToken 用于 Canvas 环境的认证
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth'; 
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'firebase/firestore';

// --- 全局配置与 Firebase 初始化 ---
// 尝试从环境中获取配置，否则使用空对象
const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
const appId = typeof __app_id !== 'undefined' ? __app_id : 'dorm-check-default';

// 目标宿舍楼的模拟坐标 (请自行替换为实际学校的中心坐标)
const TARGET_LOCATION = {
  latitude: 39.9042, // 北京 Mock 坐标
  longitude: 116.4074, 
  radius: 500 // 允许误差 500 米
};

// --- 辅助函数 ---

// Haversine 公式计算两点间距离（单位：米）
function getDistanceFromLatLonInMeters(lat1, lon1, lat2, lon2) {
  const R = 6371000; // 地球半径（米）
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  return R * c;
}
function deg2rad(deg) { return deg * (Math.PI / 180); }


// --- 主应用组件 ---
export default function App() {
  const [fbServices, setFbServices] = useState(null); // 存储 auth, db 实例
  const [user, setUser] = useState(null);
  const [view, setView] = useState('login'); // login, student, admin, success
  const [studentName, setStudentName] = useState('');
  const [studentId, setStudentId] = useState('');
  const [isInitializing, setIsInitializing] = useState(true);

  // 初始化 Firebase 和认证
  useEffect(() => {
    let unsubscribeAuth = () => {};
    
    const initApp = async () => {
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            setFbServices({ auth, db });

            // 优先使用 Canvas 环境提供的令牌认证，确保权限
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                // 如果没有令牌，则匿名登录
                await signInAnonymously(auth);
            }
            
            // 监听认证状态变化
            unsubscribeAuth = onAuthStateChanged(auth, (u) => {
                setUser(u);
                setIsInitializing(false);
            });
        } catch (e) {
            console.error("Firebase 初始化或认证失败:", e);
            alert("系统初始化失败，请检查配置或网络。");
            setIsInitializing(false);
        }
    };
    
    initApp();
    return () => unsubscribeAuth();
  }, []);

  const handleLogin = (role) => {
    if (role === 'student') {
      if (!studentName || !studentId) return alert('请先输入姓名和学号');
      setView('student');
    } else {
      setView('admin');
    }
  };

  const handleLogout = async () => {
    setView('login');
    setStudentName('');
    setStudentId('');
    // 可以选择登出，但为了简化，我们只切换视图
    // await fbServices.auth.signOut(); 
  };

  if (isInitializing || !user || !fbServices) {
    return (
      <div className="flex items-center justify-center h-screen text-blue-500 bg-gray-50">
        <div className="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
        <p className="ml-4 font-medium">系统初始化中...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-gray-100">
      
      {/* 顶部导航栏 */}
      <header className="bg-blue-600 text-white p-4 pt-8 flex justify-between items-center shadow-lg sticky top-0 z-20">
        <div className="flex items-center gap-2">
          <ShieldCheck size={20} className="text-white" />
          <h1 className="text-lg font-bold tracking-wide">智能查寝平台</h1>
        </div>
        {view !== 'login' && (
          <button onClick={handleLogout} className="text-blue-100 hover:text-white text-sm flex items-center gap-1 transition-colors">
            <LogOut size={16} /> 退出
          </button>
        )}
      </header>

      {/* 主内容区域 */}
      <main className="p-4 pb-20">
        {view === 'login' && (
          <LoginScreen 
            setStudentName={setStudentName} 
            setStudentId={setStudentId}
            studentName={studentName}
            studentId={studentId}
            onLogin={handleLogin} 
          />
        )}
        {view === 'student' && (
          <StudentCheckIn 
            db={fbServices.db}
            appId={appId}
            name={studentName} 
            sid={studentId} 
            onSuccess={() => setView('success')}
          />
        )}
        {view === 'admin' && <AdminDashboard db={fbServices.db} appId={appId} />}
        {view === 'success' && (
            <SuccessScreen onBack={() => setView('login')} />
        )}
      </main>
    </div>
  );
}

// --- 登录/角色选择组件 ---
function LoginScreen({ onLogin, setStudentName, setStudentId, studentName, studentId }) {
  const [role, setRole] = useState('student');

  return (
    <div className="flex flex-col gap-6 mt-8 animate-in fade-in duration-500">
      <div className="text-center space-y-2">
        <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
          <User size={40} className="text-blue-600" />
        </div>
        <h2 className="text-2xl font-bold text-gray-800">选择用户身份</h2>
      </div>

      <div className="bg-white p-1 rounded-xl border border-gray-200 flex shadow-sm">
        <button 
          onClick={() => setRole('student')}
          className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${role === 'student' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500'}`}
        >
          学生签到
        </button>
        <button 
          onClick={() => setRole('admin')}
          className={`flex-1 py-2 rounded-lg text-sm font-medium transition-all ${role === 'admin' ? 'bg-blue-600 text-white shadow-md' : 'text-gray-500'}`}
        >
          宿管/教师查房
        </button>
      </div>

      {role === 'student' && (
        <div className="space-y-4">
          <input
            type="text"
            placeholder="姓名"
            value={studentName}
            onChange={(e) => setStudentName(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
          />
          <input
            type="text"
            placeholder="学号"
            value={studentId}
            onChange={(e) => setStudentId(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all"
          />
        </div>
      )}

      <button
        onClick={() => onLogin(role)}
        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg shadow-blue-300 transform active:scale-98 transition-all"
      >
        {role === 'student' ? '开始签到' : '进入管理平台'}
      </button>
    </div>
  );
}

// --- 学生查寝组件 ---
function StudentCheckIn({ db, appId, name, sid, onSuccess }) {
  const [step, setStep] = useState(1); // 1:定位, 2:拍照, 3:确认
  const [location, setLocation] = useState(null);
  const [statusMsg, setStatusMsg] = useState('请获取您的当前位置...');
  const [photo, setPhoto] = useState(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const [cameraStream, setCameraStream] = useState(null);

  // 步骤 1: 获取位置
  const handleGetLocation = () => {
    setStatusMsg('正在获取 GPS 信息...');
    if (!navigator.geolocation) {
      setStatusMsg("浏览器不支持地理位置功能。");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        const dist = getDistanceFromLatLonInMeters(latitude, longitude, TARGET_LOCATION.latitude, TARGET_LOCATION.longitude);
        
        const isNear = dist <= TARGET_LOCATION.radius;
        const distMsg = `距离目标点：${Math.round(dist)}米`;

        if (!isNear) {
            setStatusMsg(`定位失败：${distMsg}，您不在指定宿舍区域。`);
            // 真实应用中此处应阻止进入下一步
        } else {
            setStatusMsg(`定位成功：${distMsg}。请继续拍照。`);
            setLocation({
                lat: latitude,
                lng: longitude,
                distance: Math.round(dist),
                inZone: isNear
            });
            setTimeout(() => setStep(2), 1000); // 1秒后进入下一步
        }
      },
      (error) => {
        console.error(error);
        setStatusMsg("定位失败，请检查手机权限或网络。");
      },
      { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
    );
  };

  // 步骤 2: 启动摄像头
  useEffect(() => {
    let cleanup = () => {};
    if (step === 2) {
      const startCamera = async () => {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'user' }, // 优先使用前置摄像头
            audio: false 
          });
          setCameraStream(stream);
          if (videoRef.current) {
            videoRef.current.srcObject = stream;
          }
          cleanup = () => stream.getTracks().forEach(track => track.stop());
        } catch (err) {
          console.error("Camera Error:", err);
          setStatusMsg("无法启动摄像头，请允许访问权限。");
          cleanup = () => {};
        }
      };
      startCamera();
    }
    return cleanup;
  }, [step]);

  // 拍照逻辑
  const takePhoto = () => {
    if (videoRef.current && canvasRef.current) {
      const video = videoRef.current;
      const canvas = canvasRef.current;
      const context = canvas.getContext('2d');
      
      // 设置 canvas 尺寸与视频匹配
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      
      // 添加水印
      context.font = "bold 30px sans-serif";
      context.fillStyle = "rgba(255, 255, 255, 0.8)";
      context.shadowColor = "black";
      context.shadowBlur = 5;

      const info1 = `姓名: ${name} | 学号: ${sid}`;
      const info2 = `时间: ${new Date().toLocaleString()}`;
      
      context.fillText(info1, 20, canvas.height - 70);
      context.fillText(info2, 20, canvas.height - 30);

      const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
      setPhoto(dataUrl);
      
      // 停止摄像头
      if (cameraStream) cameraStream.getTracks().forEach(track => track.stop());
      setStep(3);
    }
  };

  // 步骤 3: 提交数据
  const handleSubmit = async () => {
    if (!location || !photo || !db) return;

    try {
      setStatusMsg('正在提交数据...');
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checkins'), {
        studentName: name,
        studentId: sid,
        location: location,
        photoBase64: photo, 
        timestamp: serverTimestamp(),
        status: location.inZone ? '正常签到' : '位置异常'
      });
      onSuccess();
    } catch (e) {
      console.error("提交失败:", e);
      setStatusMsg("提交失败，请检查网络或联系管理员。");
      alert("数据上传失败: " + e.message);
    }
  };

  const retake = () => {
    setPhoto(null);
    setStep(2);
    setStatusMsg('请重新拍摄人脸照片。');
  };

  return (
    <div className="flex flex-col min-h-[70vh] animate-in fade-in duration-500">
        {/* 步骤指示器 */}
        <div className="flex justify-between mb-6 px-2">
            {[1, 2, 3].map(i => (
                <div key={i} className={`h-2 flex-1 mx-1 rounded-full ${step >= i ? 'bg-blue-600' : 'bg-gray-200'}`} />
            ))}
        </div>
        
        {/* 状态信息 */}
        <p className={`text-center mb-6 text-sm font-medium ${step < 3 ? 'text-blue-600' : 'text-green-600'}`}>{statusMsg}</p>


        {/* 步骤 1: 定位 */}
        {step === 1 && (
            <div className="flex-1 flex flex-col items-center justify-center space-y-6 text-center">
                <div className="w-24 h-24 bg-blue-50 rounded-full flex items-center justify-center animate-pulse">
                    <MapPin size={48} className="text-blue-500" />
                </div>
                <p className="text-gray-500 text-sm px-8">请点击按钮获取您的 GPS 位置，系统将进行区域校验。</p>
                <button onClick={handleGetLocation} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold shadow-lg active:scale-98 transition-transform">
                    {location ? `重新定位 (${Math.round(location.distance)}m)` : '获取当前位置'}
                </button>
            </div>
        )}

        {/* 步骤 2: 拍照 */}
        {step === 2 && !photo && (
            <div className="flex-1 flex flex-col relative bg-black rounded-xl overflow-hidden shadow-xl aspect-[4/3]">
                <video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover" />
                <canvas ref={canvasRef} className="hidden" />
                
                {/* 拍照按钮和信息覆盖层 */}
                <div className="absolute top-0 w-full h-full flex flex-col justify-end items-center p-6 bg-gradient-to-t from-black/60 to-transparent">
                    <div className='text-white/80 text-sm mb-4 bg-black/50 p-2 rounded-lg'>
                        请确保面部清晰可见
                    </div>
                    <button onClick={takePhoto} className="w-16 h-16 rounded-full bg-white border-4 border-gray-300 shadow-xl flex items-center justify-center active:scale-90 transition-all">
                        <Camera size={24} className="text-gray-700" />
                    </button>
                </div>
            </div>
        )}

        {/* 步骤 3: 确认 */}
        {step === 3 && photo && (
            <div className="flex-1 flex flex-col space-y-4">
                <div className="relative rounded-xl overflow-hidden shadow-md aspect-[4/3] bg-gray-100">
                    <img src={photo} alt="Captured Check-in" className="w-full h-full object-cover" />
                </div>

                <div className="space-y-3">
                    <button onClick={handleSubmit} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg active:scale-98 transition-transform flex items-center justify-center gap-2">
                        <CheckCircle size={20} /> 确认并提交记录
                    </button>
                    <button onClick={retake} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-semibold shadow-sm active:scale-98 transition-transform flex items-center justify-center gap-2">
                        <Camera size={18} /> 重新拍摄
                    </button>
                </div>
            </div>
        )}
    </div>
  );
}

// --- 签到成功组件 ---
function SuccessScreen({ onBack }) {
    return (
        <div className="flex flex-col items-center justify-center h-[70vh] text-center space-y-6 animate-in fade-in duration-500">
            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-600 animate-bounce">
                <CheckCircle size={60} />
            </div>
            <div>
                <h2 className="text-2xl font-bold text-gray-800">签到成功!</h2>
                <p className="text-gray-500 mt-2">您的查寝数据已成功上传至平台。</p>
            </div>
            <button onClick={onBack} className="mt-8 text-blue-600 font-medium hover:underline">
                返回首页
            </button>
        </div>
    )
}

// --- 教师/宿管管理面板组件 ---
function AdminDashboard({ db, appId }) {
  const [checkins, setCheckins] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // 使用 onSnapshot 监听公共集合数据，确保实时性
    const q = query(
        collection(db, 'artifacts', appId, 'public', 'data', 'checkins'),
        orderBy('timestamp', 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => {
          const docData = doc.data();
          return {
              id: doc.id,
              ...docData,
              // 格式化时间戳
              timestamp: docData.timestamp ? new Date(docData.timestamp.seconds * 1000).toLocaleString('zh-CN', { hour12: false }) : 'N/A'
          };
      });
      setCheckins(data);
      setLoading(false);
    }, (error) => {
        console.error("获取查寝记录失败:", error);
        setLoading(false);
    });

    return () => unsubscribe();
  }, [db, appId]); // 依赖 db 和 appId

  return (
    <div className="animate-in fade-in duration-500">
      <div className="flex items-center justify-between mb-4 mt-2">
        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
            <List size={20} className='text-blue-600' /> 实时查寝记录
        </h2>
        <span className="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full font-medium">
            共 {checkins.length} 条记录
        </span>
      </div>

      {loading ? (
        <div className="space-y-3">
            {[1,2,3].map(i => <div key={i} className="h-20 bg-gray-200 rounded-xl animate-pulse" />)}
        </div>
      ) : checkins.length === 0 ? (
        <div className="text-center py-10 text-gray-400 border border-dashed rounded-xl p-6">
            <List size={30} className='mx-auto mb-2' />
            暂无新的签到数据
        </div>
      ) : (
        <div className="space-y-4">
          {checkins.map(item => (
            <div key={item.id} className="bg-white rounded-xl shadow-lg border border-gray-100 p-4 flex gap-4 items-start transition-all hover:shadow-xl">
              {/* 缩略图 */}
              <div className="w-16 h-16 rounded-lg bg-gray-200 flex-shrink-0 overflow-hidden">
                {item.photoBase64 ? (
                    <img src={item.photoBase64} className="w-full h-full object-cover" alt="Check-in Face" />
                ) : (
                    <User className="w-full h-full p-4 text-gray-400" />
                )}
              </div>
              
              {/* 信息 */}
              <div className="flex-1 min-w-0">
                <div className="flex justify-between items-start mb-1">
                    <div>
                        <h3 className="font-bold text-gray-900 truncate">{item.studentName}</h3>
                        <p className="text-xs text-gray-500">学号: {item.studentId}</p>
                    </div>
                    <span className={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${item.status === '正常签到' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`}>
                        {item.status}
                    </span>
                </div>
                
                <div className="mt-2 text-xs text-gray-500 flex flex-col gap-0.5 border-t pt-2 border-gray-100">
                    <div className="flex items-center gap-1">
                        <CheckCircle size={10} /> 
                        签到时间: {item.timestamp}
                    </div>
                    <div className="flex items-center gap-1">
                        {item.location?.inZone ? <MapPin size={10} className='text-green-500' /> : <AlertTriangle size={10} className='text-red-500' />}
                        定位: {item.location?.distance}m 误差
                    </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
