<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æŸ¥å¯ç³»ç»Ÿ V1.0</title>
    <style>
        /* CSS æ ·å¼ (ä¿æŒä¸ä¹‹å‰ä¸€è‡´) */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #007bff; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="password"], button, select { padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background-color: #28a745; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #218838; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #student-view, #teacher-view { display: none; }
        .view-switch { margin-bottom: 30px; }
        .view-switch button { width: auto; margin-right: 10px; background-color: #6c757d; }
        .view-switch button.active { background-color: #007bff; }

        /* å­¦ç”Ÿç«¯ç‰¹å®šæ ·å¼ */
        #video-container { display: flex; justify-content: center; margin-bottom: 15px; }
        #video, #photo-canvas { width: 100%; max-width: 400px; border: 1px solid #ddd; background: #eee; }
        #photo-preview img { max-width: 100%; border-radius: 4px; margin-top: 15px; }
        .info-box { padding: 15px; background-color: #eaf5ff; border: 1px solid #cce5ff; border-radius: 4px; margin-bottom: 15px; }

        /* æ•™å¸ˆç«¯ç‰¹å®šæ ·å¼ */
        #checkin-list { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #checkin-list th, #checkin-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #checkin-list th { background-color: #007bff; color: white; }
        .preview-img { max-width: 150px; height: auto; display: block; margin: 5px 0; }
        .delete-btn { background-color: #dc3545; color: white; padding: 4px 8px; cursor: pointer; border-radius: 3px; font-size: 0.8em; width: auto; margin: 0; }
        .delete-btn:hover { background-color: #c82333; }

        #auth-section { margin-bottom: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 4px; }
        #teacher-controls { display: none; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ  æ™ºèƒ½æŸ¥å¯ç­¾åˆ°ç³»ç»Ÿ V1.0</h1>

        <div class="view-switch">
            <button id="switch-student" class="active">å­¦ç”Ÿç­¾åˆ°ç«¯</button>
            <button id="switch-teacher">æ•™å¸ˆç®¡ç†ç«¯</button>
        </div>

        <div id="student-view">
            <h2>ğŸ‘¤ å­¦ç”Ÿç­¾åˆ°</h2>
            <input type="text" id="student-name" placeholder="è¯·è¾“å…¥å§“å" required>
            <input type="text" id="student-id" placeholder="è¯·è¾“å…¥å­¦å·" required>

            <div class="info-box">
                <strong>ğŸ“ å½“å‰å®šä½ï¼š</strong> <span id="location-status">ç­‰å¾…è·å–å®šä½...</span>
                <button id="get-location-btn">é‡æ–°è·å–å®šä½</button>
                <p id="coords-display" style="margin: 5px 0 0 0; font-size: 0.9em;"></p>
            </div>

            <div id="video-container">
                <video id="video" autoplay></video>
                <canvas id="photo-canvas" style="display: none;"></canvas>
            </div>
            <button id="start-camera-btn">å¼€å¯æ‘„åƒå¤´</button>
            <button id="take-photo-btn" disabled>æ‹ç…§</button>
            
            <div id="photo-preview"></div>
            
            <button id="checkin-btn" disabled>âœ… ç­¾åˆ°</button>
            <p id="checkin-message" style="color: green; font-weight: bold;"></p>
        </div>

        <div id="teacher-view">
            <h2>ğŸ§‘â€ğŸ« æ•™å¸ˆç®¡ç† (å®æ—¶æ•°æ®)</h2>

            <div id="auth-section">
                <h3>ğŸ”‘ èº«ä»½éªŒè¯</h3>
                <input type="password" id="teacher-password" placeholder="è¯·è¾“å…¥ç®¡ç†å¯†ç ">
                <button id="login-btn" style="background-color: #007bff;">ç™»å½•</button>
                <p id="login-message" style="color: red;"></p>
            </div>

            <div id="teacher-controls">
                <div class="info-box">
                    <p>æ•°æ®æ¯ 10 ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡ï¼Œå±•ç¤ºæ‰€æœ‰å­¦ç”Ÿçš„ç­¾åˆ°è®°å½•ã€‚</p>
                    <p id="last-refresh" style="font-weight: bold;"></p>
                </div>
                
                <h3>ğŸ“Š ç­¾åˆ°è®°å½•</h3>
                <table id="checkin-list">
                    <thead>
                        <tr>
                            <th>å§“å/å­¦å·</th>
                            <th>æ—¶é—´</th>
                            <th>ç»çº¬åº¦</th>
                            <th>ç…§ç‰‡</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // =======================================================
        // å¯†é’¥å’ŒIDæ··æ·†å‡½æ•°
        // (é˜²æ­¢ç”¨æˆ·ç›´æ¥åœ¨æºä»£ç ä¸­æœç´¢åˆ°å®Œæ•´ Key å’Œ ID)
        // =======================================================

        // å¯†ç å®šä¹‰
        const TEACHER_PASSWORD = '123456'; 

        // æ··æ·†åçš„ BIN_ID: 6924563bae596e708f6db531
        function decodeBinId() {
            const ID_A = "6924563b";
            const ID_B = "ae596e70";
            const ID_C = "8f6db531";
            return ID_A + ID_B + ID_C;
        }

        // æ··æ·†åçš„ MASTER_KEY: $2a$10$nJeSJHBTFY6fAF1FnBkSo.wJk/7pxJJf1FuTULeo.1GwDwk01wVLS
        function decodeKey() {
            const P_A = "$2a$10$nJeSJHBTF";
            const P_B = "Y6fAF1FnBkSo.wJk";
            const P_C = "/7pxJJf1FuTULeo.1GwDwk01wVLS";
            return P_A + P_B + P_C;
        }

        const MASTER_KEY = decodeKey();
        const BIN_ID = decodeBinId(); 
        const JSONBIN_API_URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

        // --- DOM å…ƒç´  ---
        const studentView = document.getElementById('student-view');
        const teacherView = document.getElementById('teacher-view');
        const switchStudentBtn = document.getElementById('switch-student');
        const switchTeacherBtn = document.getElementById('switch-teacher');
        
        // ... (å­¦ç”Ÿç«¯å…ƒç´ å®šä¹‰ä¿æŒä¸å˜) ...
        const studentNameInput = document.getElementById('student-name');
        const studentIdInput = document.getElementById('student-id');
        const locationStatus = document.getElementById('location-status');
        const coordsDisplay = document.getElementById('coords-display');
        const getLocationBtn = document.getElementById('get-location-btn');
        const video = document.getElementById('video');
        const photoCanvas = document.getElementById('photo-canvas');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const photoPreview = document.getElementById('photo-preview');
        const checkinBtn = document.getElementById('checkin-btn');
        const checkinMessage = document.getElementById('checkin-message');

        // --- æ•™å¸ˆç«¯å…ƒç´  ---
        const authSection = document.getElementById('auth-section');
        const teacherControls = document.getElementById('teacher-controls');
        const teacherPasswordInput = document.getElementById('teacher-password');
        const loginBtn = document.getElementById('login-btn');
        const loginMessage = document.getElementById('login-message');
        const checkinListBody = document.querySelector('#checkin-list tbody');
        const lastRefreshDisplay = document.getElementById('last-refresh');
        
        // --- çŠ¶æ€å˜é‡ ---
        let currentPosition = null;
        let photoDataURL = null;
        let videoStream = null;
        let isLoggedIn = false; // ç™»å½•çŠ¶æ€

        // =======================================================
        // 1. è§†å›¾åˆ‡æ¢å’Œç™»å½•éªŒè¯
        // =======================================================

        function setView(view) {
            if (view === 'student') {
                studentView.style.display = 'block';
                teacherView.style.display = 'none';
                switchStudentBtn.classList.add('active');
                switchTeacherBtn.classList.remove('active');
            } else {
                studentView.style.display = 'none';
                teacherView.style.display = 'block';
                switchStudentBtn.classList.remove('active');
                switchTeacherBtn.classList.add('active');
                
                // åˆ‡æ¢åˆ°æ•™å¸ˆç«¯æ—¶ï¼Œæ ¹æ®ç™»å½•çŠ¶æ€å†³å®šæ˜¾ç¤ºå†…å®¹
                if (isLoggedIn) {
                    authSection.style.display = 'none';
                    teacherControls.style.display = 'block';
                    renderCheckinList(); 
                } else {
                    authSection.style.display = 'block';
                    teacherControls.style.display = 'none';
                    loginMessage.textContent = '';
                }
            }
        }

        loginBtn.addEventListener('click', () => {
            if (teacherPasswordInput.value === TEACHER_PASSWORD) {
                isLoggedIn = true;
                loginMessage.textContent = 'ç™»å½•æˆåŠŸï¼';
                setView('teacher'); // é‡æ–°è°ƒç”¨ setView åˆ·æ–°ç•Œé¢
            } else {
                loginMessage.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
                teacherPasswordInput.value = '';
            }
        });
        
        // ç»‘å®šå›è½¦é”®ç™»å½•
        teacherPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                loginBtn.click();
            }
        });

        switchStudentBtn.addEventListener('click', () => setView('student'));
        switchTeacherBtn.addEventListener('click', () => setView('teacher'));

        // =======================================================
        // 2. ç­¾åˆ°å’Œæ•°æ®ä¸Šä¼  (ä¿æŒä¸å˜)
        // =======================================================
        // (ç•¥å»å®šä½å’Œæ‹ç…§ç›¸å…³å‡½æ•°ï¼Œä¿æŒå…¶åŸæœ‰é€»è¾‘ä¸å˜)
        // ...
        
        // é‡æ–°å®šä¹‰ checkinBtn.addEventListener ç”¨äºæ›´æ–°æ•°æ®
        checkinBtn.addEventListener('click', async () => {
            if (checkinBtn.disabled) return;

            const name = studentNameInput.value.trim();
            const id = studentIdInput.value.trim();
            // ... (æ ¡éªŒé€»è¾‘ä¿æŒä¸å˜) ...

            const newRecord = {
                name: name,
                id: id,
                // ä¸ºäº†åˆ é™¤åŠŸèƒ½ï¼Œåˆ›å»ºå”¯ä¸€çš„ UUID æˆ–ä½¿ç”¨ ID+Timestamp çš„ç»„åˆ
                uniqueKey: `${id}-${new Date().getTime()}`, 
                timestamp: new Date().toISOString(), 
                latitude: currentPosition.latitude,
                longitude: currentPosition.longitude,
                accuracy: currentPosition.accuracy,
                photo: photoDataURL 
            };

            checkinBtn.disabled = true;
            checkinMessage.textContent = 'æ­£åœ¨è·å–ç°æœ‰æ•°æ®å¹¶æäº¤...';

            try {
                // 1. GET: è·å–ç°æœ‰æ•°æ®
                const getResponse = await fetch(JSONBIN_API_URL, {
                    method: 'GET',
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                const currentData = await getResponse.json();
                let records = currentData.record || [];

                // 2. APPEND: æ·»åŠ æ–°è®°å½•
                records.push(newRecord);
                
                // 3. PUT: æäº¤æ•´ä¸ªæ›´æ–°åçš„æ•°æ®
                const putResponse = await fetch(JSONBIN_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': MASTER_KEY 
                    },
                    body: JSON.stringify(records)
                });

                if (putResponse.ok) {
                    checkinMessage.textContent = `âœ… ç­¾åˆ°æˆåŠŸï¼æ—¶é—´: ${new Date().toLocaleString('zh-CN')}`;
                } else {
                    const errorJson = await putResponse.json();
                    throw new Error(`æ›´æ–°å¤±è´¥: ${putResponse.status}. è¯¦æƒ…: ${errorJson.message || 'æœªçŸ¥é”™è¯¯'}`);
                }

            } catch (error) {
                checkinMessage.textContent = `âŒ ç­¾åˆ°å¤±è´¥ï¼š${error.message}`;
                console.error('Check-in failed:', error);
            } finally {
                checkinBtn.disabled = false;
                // é‡ç½®çŠ¶æ€
                // ... (é‡ç½®é€»è¾‘ä¿æŒä¸å˜) ...
            }
        });


        // =======================================================
        // 3. æ•™å¸ˆç«¯åŠŸèƒ½ï¼šå®æ—¶æ•°æ®æ˜¾ç¤ºå’Œåˆ é™¤
        // =======================================================

        async function renderCheckinList() {
            if (!isLoggedIn) return; // æœªç™»å½•ä¸æ‰§è¡Œæ¸²æŸ“

            checkinListBody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #007bff;">æ­£åœ¨å®æ—¶è·å–ç­¾åˆ°æ•°æ®...</td></tr>';
            lastRefreshDisplay.textContent = `ä¸Šæ¬¡åˆ·æ–°æ—¶é—´: ${new Date().toLocaleTimeString('zh-CN')}`;
            
            try {
                const response = await fetch(JSONBIN_API_URL, { 
                    method: 'GET',
                    headers: { 'X-Master-Key': MASTER_KEY } 
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                const records = data.record || []; 

                // ----------------- æ•°æ®æ¸²æŸ“é€»è¾‘ -----------------
                checkinListBody.innerHTML = '';

                if (records.length === 0) {
                    checkinListBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">æš‚æ— ç­¾åˆ°è®°å½•</td></tr>';
                    return;
                }

                // æŒ‰æ—¶é—´æˆ³å€’åºæ’åº
                records.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); 

                records.forEach(record => {
                    const row = checkinListBody.insertRow();
                    row.insertCell().innerHTML = `<strong>${record.name}</strong><br><small>${record.id}</small>`;
                    row.insertCell().textContent = record.timestamp ? new Date(record.timestamp).toLocaleString('zh-CN') : 'N/A';
                    row.insertCell().textContent = (record.latitude && record.longitude) ? 
                        `${parseFloat(record.latitude).toFixed(4)}, ${parseFloat(record.longitude).toFixed(4)}` : 'æœªè·å–';

                    // ç…§ç‰‡é¢„è§ˆ
                    const imgCell = row.insertCell();
                    if (record.photo) {
                        const img = document.createElement('img');
                        img.src = record.photo;
                        img.alt = 'ç­¾åˆ°ç…§ç‰‡';
                        img.className = 'preview-img';
                        imgCell.appendChild(img);
                    } else {
                        imgCell.textContent = 'æ— ç…§ç‰‡';
                    }

                    // åˆ é™¤æŒ‰é’®
                    const actionCell = row.insertCell();
                    const deleteBtn = document.createElement('button');
                    deleteBtn.textContent = 'åˆ é™¤';
                    deleteBtn.className = 'delete-btn';
                    // å°† uniqueKey ç»‘å®šåˆ°æŒ‰é’®ï¼Œç”¨äºåˆ é™¤æ—¶è¯†åˆ«è®°å½•
                    deleteBtn.dataset.key = record.uniqueKey; 
                    actionCell.appendChild(deleteBtn);
                });

                // ç»‘å®šåˆ é™¤äº‹ä»¶
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', handleDeleteRecord);
                });

            } catch (error) {
                checkinListBody.innerHTML = `<tr><td colspan="5" style="text-align: center; color: red;">âŒ è·å–æ•°æ®å¤±è´¥: ${error.message}ã€‚</td></tr>`;
                console.error('Failed to fetch check-in data:', error);
            }
        }

        async function handleDeleteRecord(event) {
            const uniqueKey = event.target.dataset.key;
            if (!confirm(`ç¡®å®šè¦åˆ é™¤æ­¤ç­¾åˆ°è®°å½•å—ï¼ŸKey: ${uniqueKey}`)) {
                return;
            }

            try {
                // 1. GET: è·å–æœ€æ–°æ•°æ®
                const getResponse = await fetch(JSONBIN_API_URL, {
                    method: 'GET',
                    headers: { 'X-Master-Key': MASTER_KEY }
                });
                const currentData = await getResponse.json();
                let records = currentData.record || [];

                // 2. FILTER: ç§»é™¤åŒ¹é…çš„è®°å½•
                const updatedRecords = records.filter(record => record.uniqueKey !== uniqueKey);

                if (updatedRecords.length === records.length) {
                    alert('é”™è¯¯ï¼šæœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•è¿›è¡Œåˆ é™¤ã€‚');
                    return;
                }

                // 3. PUT: æäº¤æ›´æ–°åçš„æ•°æ®
                const putResponse = await fetch(JSONBIN_API_URL, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': MASTER_KEY 
                    },
                    body: JSON.stringify(updatedRecords)
                });

                if (putResponse.ok) {
                    alert('è®°å½•åˆ é™¤æˆåŠŸï¼');
                    renderCheckinList(); // åˆ·æ–°åˆ—è¡¨
                } else {
                    throw new Error('åˆ é™¤æ“ä½œæäº¤å¤±è´¥ã€‚');
                }

            } catch (error) {
                alert(`åˆ é™¤å¤±è´¥: ${error.message}`);
                console.error('Delete failed:', error);
            }
        }


        // =======================================================
        // 4. åˆå§‹åŒ–å’Œå®æ—¶åˆ·æ–°
        // =======================================================

        function setupRealtimeRefresh() {
            if (teacherView.style.display !== 'none' && isLoggedIn) {
                renderCheckinList();
            }
        }

        setInterval(setupRealtimeRefresh, 10000); 
        
        // é»˜è®¤æ˜¾ç¤ºå­¦ç”Ÿç«¯
        setView('student');

    </script>
</body>
</html>
