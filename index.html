import React, { useState, useEffect, useRef } from 'react';
import { Camera, MapPin, User, CheckCircle, XCircle, RefreshCw, ShieldCheck, List, LogOut, Moon } from 'lucide-react';
import { initializeApp } from 'firebase/app';
// ä¿®å¤: å¯¼å…¥ signInWithCustomToken ä»¥ä¾¿æ­£ç¡®å¤„ç† Canvas ç¯å¢ƒçš„è®¤è¯
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from 'firebase/auth'; 
import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp } from 'firebase/firestore';

// --- Firebase Initialization ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'dorm-check-default';

// --- Mock Target Location (Dormitory Coordinates) ---
// In a real app, this would be fetched from a database based on the student's dorm building
const TARGET_LOCATION = {
  latitude: 39.9042, // Mock latitude
  longitude: 116.4074, // Mock longitude
  radius: 500 // meters allowed
};

// --- Helper: Calculate Distance (Haversine Formula) ---
function getDistanceFromLatLonInKm(lat1, lon1, lat2, lon2) {
  const R = 6371; // Radius of the earth in km
  const dLat = deg2rad(lat2 - lat1);
  const dLon = deg2rad(lon2 - lon1);
  const a =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
    Math.sin(dLon / 2) * Math.sin(dLon / 2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  const d = R * c; // Distance in km
  return d * 1000; // Return in meters
}

function deg2rad(deg) {
  return deg * (Math.PI / 180);
}

// --- Component: Main App ---
export default function App() {
  const [user, setUser] = useState(null);
  const [view, setView] = useState('login'); // login, student, admin
  const [studentName, setStudentName] = useState('');
  const [studentId, setStudentId] = useState('');

  // ä¿®å¤åçš„ Auth Effect
  useEffect(() => {
    const initAuth = async () => {
        try {
            // ä¼˜å…ˆä½¿ç”¨ Canvas ç¯å¢ƒæä¾›çš„è‡ªå®šä¹‰ä»¤ç‰Œè¿›è¡Œè®¤è¯
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                // å¦‚æœæ²¡æœ‰ä»¤ç‰Œï¼Œåˆ™é€€å›åˆ°åŒ¿åç™»å½•
                await signInAnonymously(auth);
            }
        } catch (e) {
            console.error("Firebase è®¤è¯å¤±è´¥:", e);
            // æœ€ç»ˆå®‰å…¨æªæ–½ï¼šå°è¯•åŒ¿åç™»å½•
            await signInAnonymously(auth); 
        }
    };
    initAuth();
    // è®¾ç½®ç›‘å¬å™¨ä»¥è·Ÿè¸ªè®¤è¯çŠ¶æ€å˜åŒ–å¹¶æ›´æ–° user state
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []); // ç©ºä¾èµ–æ•°ç»„ç¡®ä¿åªè¿è¡Œä¸€æ¬¡

  const handleLogin = (role) => {
    if (role === 'student') {
      if (!studentName || !studentId) return alert('è¯·è¾“å…¥å§“åå’Œå­¦å·');
      setView('student');
    } else {
      setView('admin');
    }
  };

  const handleLogout = () => {
    setView('login');
    setStudentName('');
    setStudentId('');
  };

  if (!user) return <div className="flex items-center justify-center h-screen text-blue-500">åŠ è½½ç³»ç»Ÿä¸­...</div>;

  return (
    <div className="min-h-screen bg-gray-50 font-sans text-gray-800 max-w-md mx-auto shadow-2xl overflow-hidden relative border-x border-gray-200">
      
      {/* Header */}
      <header className="bg-blue-600 text-white p-4 flex justify-between items-center shadow-md z-10 sticky top-0">
        <div className="flex items-center gap-2">
          <Moon size={20} className="text-yellow-300" />
          <h1 className="text-lg font-bold tracking-wide">æ™ºæ…§æŸ¥å¯</h1>
        </div>
        {view !== 'login' && (
          <button onClick={handleLogout} className="text-blue-100 hover:text-white text-sm flex items-center gap-1">
            <LogOut size={16} /> é€€å‡º
          </button>
        )}
      </header>

      {/* Main Content */}
      <main className="p-4 pb-20">
        {view === 'login' && (
          <LoginScreen 
            setStudentName={setStudentName} 
            setStudentId={setStudentId}
            studentName={studentName}
            studentId={studentId}
            onLogin={handleLogin} 
          />
        )}
        {view === 'student' && (
          <StudentCheckIn 
            user={user} 
            name={studentName} 
            sid={studentId} 
            onSuccess={() => setView('success')}
          />
        )}
        {view === 'admin' && <AdminDashboard user={user} />}
        {view === 'success' && (
            <SuccessScreen onBack={() => setView('login')} />
        )}
      </main>

    </div>
  );
}

// --- Sub-Component: Login Screen ---
function LoginScreen({ onLogin, setStudentName, setStudentId, studentName, studentId }) {
  const [role, setRole] = useState('student');

  return (
    <div className="flex flex-col gap-6 mt-8 animate-fade-in">
      <div className="text-center space-y-2">
        <div className="bg-blue-100 w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-4">
          <ShieldCheck size={40} className="text-blue-600" />
        </div>
        <h2 className="text-2xl font-bold text-gray-800">æ¬¢è¿ä½¿ç”¨æŸ¥å¯ç³»ç»Ÿ</h2>
        <p className="text-gray-500 text-sm">å®šä½ + æ‹ç…§ + å®åè®¤è¯</p>
      </div>

      <div className="bg-white p-1 rounded-lg border flex mb-4">
        <button 
          onClick={() => setRole('student')}
          className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${role === 'student' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500'}`}
        >
          å­¦ç”Ÿç­¾åˆ°
        </button>
        <button 
          onClick={() => setRole('admin')}
          className={`flex-1 py-2 rounded-md text-sm font-medium transition-all ${role === 'admin' ? 'bg-blue-600 text-white shadow-sm' : 'text-gray-500'}`}
        >
          å®¿ç®¡æŸ¥æˆ¿
        </button>
      </div>

      {role === 'student' ? (
        <div className="space-y-4">
          <input
            type="text"
            placeholder="è¯·è¾“å…¥å§“å"
            value={studentName}
            onChange={(e) => setStudentName(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
          />
          <input
            type="text"
            placeholder="è¯·è¾“å…¥å­¦å·"
            value={studentId}
            onChange={(e) => setStudentId(e.target.value)}
            className="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition-all"
          />
        </div>
      ) : (
        <div className="p-4 bg-yellow-50 text-yellow-800 rounded-lg text-sm border border-yellow-200">
          ç®¡ç†å‘˜æ¨¡å¼æ— éœ€è¾“å…¥è´¦å·ï¼Œç›´æ¥è¿›å…¥æŸ¥çœ‹æ‰€æœ‰æ•°æ®ã€‚
        </div>
      )}

      <button
        onClick={() => onLogin(role)}
        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3.5 rounded-xl shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2"
      >
        {role === 'student' ? 'å¼€å§‹ç­¾åˆ°' : 'è¿›å…¥ç®¡ç†ç«¯'}
      </button>
    </div>
  );
}

// --- Sub-Component: Student Check-In Flow ---
function StudentCheckIn({ user, name, sid, onSuccess }) {
  const [step, setStep] = useState(1); // 1: Location, 2: Camera, 3: Submitting
  const [location, setLocation] = useState(null);
  const [locError, setLocError] = useState(null);
  const [photo, setPhoto] = useState(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null);
  const [cameraStream, setCameraStream] = useState(null);

  // Step 1: Get Location
  const handleGetLocation = () => {
    setLocError(null);
    if (!navigator.geolocation) {
      setLocError("æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®åŠŸèƒ½");
      return;
    }

    navigator.geolocation.getCurrentPosition(
      (position) => {
        const { latitude, longitude } = position.coords;
        // Mock check distance logic (always pass for demo purposes mostly, or show warning)
        const dist = getDistanceFromLatLonInKm(latitude, longitude, TARGET_LOCATION.latitude, TARGET_LOCATION.longitude);
        
        // In a real app, strict check: if (dist > TARGET_LOCATION.radius) ...
        
        setLocation({
          lat: latitude,
          lng: longitude,
          distance: Math.round(dist),
          timestamp: new Date().toLocaleString()
        });
        setStep(2);
      },
      (error) => {
        console.error(error);
        setLocError("æ— æ³•è·å–ä½ç½®ï¼Œè¯·æ£€æŸ¥æ‰‹æœºGPSè®¾ç½®æˆ–æµè§ˆå™¨æƒé™ã€‚");
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
  };

  // Step 2: Camera
  useEffect(() => {
    if (step === 2) {
      startCamera();
    }
    return () => stopCamera();
  }, [step]);

  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ 
        video: { facingMode: 'user' },
        audio: false 
      });
      setCameraStream(stream);
      if (videoRef.current) {
        videoRef.current.srcObject = stream;
      }
    } catch (err) {
      console.error("Camera Error:", err);
      alert("æ— æ³•å¯åŠ¨æ‘„åƒå¤´ï¼Œè¯·å…è®¸è®¿é—®æƒé™ã€‚");
    }
  };

  const stopCamera = () => {
    if (cameraStream) {
      cameraStream.getTracks().forEach(track => track.stop());
      setCameraStream(null);
    }
  };

  const takePhoto = () => {
    if (videoRef.current && canvasRef.current) {
      const context = canvasRef.current.getContext('2d');
      // Set canvas dimensions to match video
      canvasRef.current.width = videoRef.current.videoWidth;
      canvasRef.current.height = videoRef.current.videoHeight;
      // Draw
      context.drawImage(videoRef.current, 0, 0);
      // Add timestamp watermark
      context.font = "20px Arial";
      context.fillStyle = "white";
      context.fillText(new Date().toLocaleString(), 20, 40);
      context.fillText(`${name} (${sid})`, 20, 70);

      const dataUrl = canvasRef.current.toDataURL('image/jpeg', 0.8);
      setPhoto(dataUrl);
      stopCamera();
      setStep(3);
    }
  };

  // Step 3: Submit
  const handleSubmit = async () => {
    if (!user || !location || !photo) return;

    try {
      await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'checkins'), {
        studentName: name,
        studentId: sid,
        location: location,
        photoBase64: photo, // Storing base64 directly for demo simplicity (1MB limit!)
        timestamp: serverTimestamp(),
        status: 'On Time'
      });
      onSuccess();
    } catch (e) {
      console.error("Submission failed", e);
      alert("æäº¤å¤±è´¥ï¼Œè¯·é‡è¯•: " + e.message);
    }
  };

  const retake = () => {
    setPhoto(null);
    setStep(2);
  };

  return (
    <div className="flex flex-col h-full animate-fade-in">
        {/* Progress Bar */}
        <div className="flex justify-between mb-6 px-2">
            {[1, 2, 3].map(i => (
                <div key={i} className={`h-2 flex-1 mx-1 rounded-full ${step >= i ? 'bg-blue-600' : 'bg-gray-200'}`} />
            ))}
        </div>

        {/* Step 1: Location */}
        {step === 1 && (
            <div className="flex-1 flex flex-col items-center justify-center space-y-6 text-center">
                <div className="w-32 h-32 bg-blue-50 rounded-full flex items-center justify-center animate-pulse">
                    <MapPin size={64} className="text-blue-500" />
                </div>
                <div>
                    <h3 className="text-xl font-bold text-gray-800">æ­¥éª¤ 1: å®šä½æ ¡éªŒ</h3>
                    <p className="text-gray-500 text-sm mt-2 px-8">ç³»ç»Ÿå°†è·å–æ‚¨çš„GPSä¿¡æ¯ä»¥ç¡®è®¤æ‚¨åœ¨å®¿èˆåŒºåŸŸã€‚</p>
                </div>
                {locError && <div className="text-red-500 bg-red-50 p-3 rounded text-sm max-w-xs">{locError}</div>}
                
                <button onClick={handleGetLocation} className="w-full bg-blue-600 text-white py-3 rounded-xl font-semibold shadow-lg active:scale-95 transition-transform">
                    è·å–å½“å‰ä½ç½®
                </button>
            </div>
        )}

        {/* Step 2: Camera */}
        {step === 2 && !photo && (
            <div className="flex-1 flex flex-col relative bg-black rounded-xl overflow-hidden shadow-xl">
                <video ref={videoRef} autoPlay playsInline className="absolute inset-0 w-full h-full object-cover" />
                <canvas ref={canvasRef} className="hidden" />
                
                {/* Overlays */}
                <div className="absolute top-4 left-4 right-4 z-10">
                   <div className="bg-black/50 text-white px-3 py-1 rounded-full text-xs inline-flex items-center gap-1 backdrop-blur-sm">
                        <MapPin size={12} /> 
                        {location ? `å·²å®šä½: è¯¯å·® ${location.distance}m` : 'å®šä½ä¸­...'}
                   </div>
                </div>

                <div className="absolute inset-0 pointer-events-none border-2 border-white/30 rounded-xl">
                    <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-48 h-64 border-2 border-dashed border-yellow-400 rounded-full opacity-70"></div>
                    <div className="absolute bottom-24 w-full text-center text-white/80 text-sm">è¯·å°†é¢éƒ¨å¯¹å‡†æ¡†å†…</div>
                </div>

                <div className="absolute bottom-0 w-full p-6 flex justify-center bg-gradient-to-t from-black/80 to-transparent">
                    <button onClick={takePhoto} className="w-16 h-16 rounded-full bg-white border-4 border-gray-300 shadow-lg flex items-center justify-center active:scale-90 transition-all">
                        <div className="w-14 h-14 rounded-full bg-white border-2 border-black"></div>
                    </button>
                </div>
            </div>
        )}

        {/* Step 3: Confirmation */}
        {step >= 2 && photo && (
            <div className="flex-1 flex flex-col space-y-4">
                <div className="relative rounded-xl overflow-hidden shadow-md aspect-[3/4] bg-gray-100">
                    <img src={photo} alt="Capture" className="w-full h-full object-cover" />
                    <div className="absolute bottom-0 w-full bg-black/60 p-2 text-white text-xs">
                        <p>ğŸ“ ç»åº¦: {location.lng.toFixed(4)}</p>
                        <p>ğŸ“ çº¬åº¦: {location.lat.toFixed(4)}</p>
                        <p>ğŸ•’ æ—¶é—´: {location.timestamp}</p>
                    </div>
                </div>

                <div className="space-y-3">
                    <button onClick={handleSubmit} className="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <CheckCircle size={20} /> ç¡®è®¤å¹¶æäº¤
                    </button>
                    <button onClick={retake} className="w-full bg-white border border-gray-300 text-gray-700 py-3 rounded-xl font-semibold shadow-sm active:scale-95 transition-transform flex items-center justify-center gap-2">
                        <RefreshCw size={18} /> é‡æ–°æ‹æ‘„
                    </button>
                </div>
            </div>
        )}
    </div>
  );
}

// --- Sub-Component: Success Screen ---
function SuccessScreen({ onBack }) {
    return (
        <div className="flex flex-col items-center justify-center h-[80vh] text-center space-y-6 animate-fade-in">
            <div className="w-24 h-24 bg-green-100 rounded-full flex items-center justify-center text-green-600 animate-bounce">
                <CheckCircle size={60} />
            </div>
            <div>
                <h2 className="text-2xl font-bold text-gray-800">ç­¾åˆ°æˆåŠŸ!</h2>
                <p className="text-gray-500 mt-2">æ‚¨çš„æŸ¥å¯æ•°æ®å·²ä¸Šä¼ è‡³äº‘ç«¯ã€‚</p>
            </div>
            <button onClick={onBack} className="mt-8 text-blue-600 font-medium hover:underline">
                è¿”å›é¦–é¡µ
            </button>
        </div>
    )
}

// --- Sub-Component: Admin Dashboard ---
function AdminDashboard({ user }) {
  const [checkins, setCheckins] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    // ç¡®ä¿ç”¨æˆ·å·²è®¤è¯ï¼Œå³ä½¿æ˜¯åŒ¿åç”¨æˆ·ï¼Œä¹Ÿåº”è¯¥æœ‰ UID
    if (!user || !user.uid) return; 
    
    // Query Public Collection
    const q = query(
        collection(db, 'artifacts', appId, 'public', 'data', 'checkins'),
        orderBy('timestamp', 'desc')
    );

    const unsubscribe = onSnapshot(q, (snapshot) => {
      const data = snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data()
      }));
      setCheckins(data);
      setLoading(false);
    }, (error) => {
        console.error("Error fetching checkins:", error);
        setLoading(false);
    });

    return () => unsubscribe();
  }, [user]);

  return (
    <div className="animate-fade-in">
      <div className="flex items-center justify-between mb-4">
        <h2 className="text-xl font-bold text-gray-800 flex items-center gap-2">
            <List size={20} /> å®æ—¶æŸ¥å¯è®°å½•
        </h2>
        <span className="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full font-medium">
            å…± {checkins.length} äºº
        </span>
      </div>

      {loading ? (
        <div className="space-y-3">
            {[1,2,3].map(i => <div key={i} className="h-20 bg-gray-200 rounded-lg animate-pulse" />)}
        </div>
      ) : checkins.length === 0 ? (
        <div className="text-center py-10 text-gray-400">
            æš‚æ— ç­¾åˆ°æ•°æ®
        </div>
      ) : (
        <div className="space-y-4">
          {checkins.map(item => (
            <div key={item.id} className="bg-white rounded-xl shadow-sm border border-gray-100 p-3 flex gap-4 items-start">
              {/* Thumbnail */}
              <div className="w-16 h-16 rounded-lg bg-gray-200 flex-shrink-0 overflow-hidden cursor-pointer hover:opacity-90">
                {item.photoBase64 ? (
                    <img src={item.photoBase64} className="w-full h-full object-cover" alt="face" />
                ) : (
                    <User className="w-full h-full p-4 text-gray-400" />
                )}
              </div>
              
              {/* Info */}
              <div className="flex-1 min-w-0">
                <div className="flex justify-between items-start">
                    <div>
                        <h3 className="font-bold text-gray-900 truncate">{item.studentName}</h3>
                        <p className="text-xs text-gray-500">{item.studentId}</p>
                    </div>
                    <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                        {item.status}
                    </span>
                </div>
                
                <div className="mt-2 text-xs text-gray-400 flex flex-col gap-0.5">
                    <div className="flex items-center gap-1">
                        <MapPin size={10} /> 
                        {item.location?.lat.toFixed(4)}, {item.location?.lng.toFixed(4)}
                    </div>
                    <div className="flex items-center gap-1">
                        <CheckCircle size={10} /> 
                        {item.timestamp ? new Date(item.timestamp.seconds * 1000).toLocaleString() : 'Just now'}
                    </div>
                </div>
              </div>
            </div>
          ))}
        </div>
      )}
    </div>
  );
}
