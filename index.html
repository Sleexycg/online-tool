<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ™ºèƒ½æŸ¥å¯ç³»ç»Ÿ</title>
    <style>
        /* CSS æ ·å¼ */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f7f6; color: #333; }
        .container { max-width: 900px; margin: 0 auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #007bff; border-bottom: 2px solid #e9ecef; padding-bottom: 10px; margin-bottom: 20px; }
        input[type="text"], input[type="file"], button, select { padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; width: 100%; box-sizing: border-box; }
        button { background-color: #28a745; color: white; cursor: pointer; border: none; transition: background-color 0.3s; }
        button:hover:not(:disabled) { background-color: #218838; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        #student-view, #teacher-view { display: none; }
        .view-switch { margin-bottom: 30px; }
        .view-switch button { width: auto; margin-right: 10px; background-color: #6c757d; }
        .view-switch button.active { background-color: #007bff; }

        /* å­¦ç”Ÿç«¯ç‰¹å®šæ ·å¼ */
        #video-container { display: flex; justify-content: center; margin-bottom: 15px; }
        #video, #photo-canvas { width: 100%; max-width: 400px; border: 1px solid #ddd; background: #eee; }
        #photo-preview img { max-width: 100%; border-radius: 4px; margin-top: 15px; }
        .info-box { padding: 15px; background-color: #eaf5ff; border: 1px solid #cce5ff; border-radius: 4px; margin-bottom: 15px; }

        /* æ•™å¸ˆç«¯ç‰¹å®šæ ·å¼ */
        #checkin-list { width: 100%; border-collapse: collapse; margin-top: 20px; }
        #checkin-list th, #checkin-list td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #checkin-list th { background-color: #007bff; color: white; }
        .preview-img { max-width: 150px; height: auto; display: block; margin: 5px 0; }
        .data-buttons button { background-color: #17a2b8; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="container">
        <h1>ğŸ  æ™ºèƒ½æŸ¥å¯ç­¾åˆ°ç³»ç»Ÿ</h1>

        <div class="view-switch">
            <button id="switch-student" class="active">å­¦ç”Ÿç­¾åˆ°ç«¯</button>
            <button id="switch-teacher">æ•™å¸ˆç®¡ç†ç«¯</button>
        </div>

        <div id="student-view">
            <h2>ğŸ‘¤ å­¦ç”Ÿç­¾åˆ°</h2>
            <input type="text" id="student-name" placeholder="è¯·è¾“å…¥å§“å" required>
            <input type="text" id="student-id" placeholder="è¯·è¾“å…¥å­¦å·" required>

            <div class="info-box">
                <strong>ğŸ“ å½“å‰å®šä½ï¼š</strong> <span id="location-status">ç­‰å¾…è·å–å®šä½...</span>
                <button id="get-location-btn">é‡æ–°è·å–å®šä½</button>
                <p id="coords-display" style="margin: 5px 0 0 0; font-size: 0.9em;"></p>
            </div>

            <div id="video-container">
                <video id="video" autoplay></video>
                <canvas id="photo-canvas" style="display: none;"></canvas>
            </div>
            <button id="start-camera-btn">å¼€å¯æ‘„åƒå¤´</button>
            <button id="take-photo-btn" disabled>æ‹ç…§</button>
            
            <div id="photo-preview"></div>
            
            <button id="checkin-btn" disabled>âœ… ç­¾åˆ°</button>
            <p id="checkin-message" style="color: green; font-weight: bold;"></p>
        </div>

        <div id="teacher-view">
            <h2>ğŸ§‘â€ğŸ« æ•™å¸ˆç®¡ç†</h2>

            <div class="data-buttons">
                <h3>æ•°æ®æ“ä½œï¼ˆæœ¬åœ°æµè§ˆå™¨å­˜å‚¨ï¼‰</h3>
                <button id="export-data-btn">ğŸ’¾ å¯¼å‡ºç­¾åˆ°æ•°æ® (JSON)</button>
                <p>å¯¼å…¥æ•°æ®ï¼šè¯·é€‰æ‹©å­¦ç”Ÿå¯¼å‡ºçš„ JSON æ–‡ä»¶</p>
                <input type="file" id="import-data-file" accept=".json">
                <button id="clear-data-btn" style="background-color: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºæœ¬åœ°ç­¾åˆ°æ•°æ®</button>
            </div>

            <h3>ğŸ“Š ç­¾åˆ°è®°å½•</h3>
            <table id="checkin-list">
                <thead>
                    <tr>
                        <th>å§“å</th>
                        <th>å­¦å·</th>
                        <th>æ—¶é—´</th>
                        <th>ç»çº¬åº¦</th>
                        <th>ä½ç½®</th>
                        <th>ç…§ç‰‡</th>
                    </tr>
                </thead>
                <tbody>
                    </tbody>
            </table>
        </div>
    </div>

    <script>
        // JavaScript é€»è¾‘
        const studentView = document.getElementById('student-view');
        const teacherView = document.getElementById('teacher-view');
        const switchStudentBtn = document.getElementById('switch-student');
        const switchTeacherBtn = document.getElementById('switch-teacher');
        
        // --- å­¦ç”Ÿç«¯å…ƒç´  ---
        const studentNameInput = document.getElementById('student-name');
        const studentIdInput = document.getElementById('student-id');
        const locationStatus = document.getElementById('location-status');
        const coordsDisplay = document.getElementById('coords-display');
        const getLocationBtn = document.getElementById('get-location-btn');
        const video = document.getElementById('video');
        const photoCanvas = document.getElementById('photo-canvas');
        const startCameraBtn = document.getElementById('start-camera-btn');
        const takePhotoBtn = document.getElementById('take-photo-btn');
        const photoPreview = document.getElementById('photo-preview');
        const checkinBtn = document.getElementById('checkin-btn');
        const checkinMessage = document.getElementById('checkin-message');

        // --- æ•™å¸ˆç«¯å…ƒç´  ---
        const checkinListBody = document.querySelector('#checkin-list tbody');
        const exportDataBtn = document.getElementById('export-data-btn');
        const importDataFile = document.getElementById('import-data-file');
        const clearDataBtn = document.getElementById('clear-data-btn');

        // --- çŠ¶æ€å˜é‡ ---
        let currentPosition = null;
        let photoDataURL = null;
        let videoStream = null;

        // =======================================================
        // 1. è§†å›¾åˆ‡æ¢
        // =======================================================

        function setView(view) {
            if (view === 'student') {
                studentView.style.display = 'block';
                teacherView.style.display = 'none';
                switchStudentBtn.classList.add('active');
                switchTeacherBtn.classList.remove('active');
            } else {
                studentView.style.display = 'none';
                teacherView.style.display = 'block';
                switchStudentBtn.classList.remove('active');
                switchTeacherBtn.classList.add('active');
                renderCheckinList(); // åˆ‡æ¢åˆ°æ•™å¸ˆç«¯æ—¶åˆ·æ–°åˆ—è¡¨
            }
        }

        switchStudentBtn.addEventListener('click', () => setView('student'));
        switchTeacherBtn.addEventListener('click', () => setView('teacher'));

        // =======================================================
        // 2. å®šä½åŠŸèƒ½ (Geolocation API)
        // =======================================================

        function updateCheckinButtonState() {
            const hasCoords = !!currentPosition;
            const hasPhoto = !!photoDataURL;
            const hasName = studentNameInput.value.trim().length > 0;
            const hasId = studentIdInput.value.trim().length > 0;
            checkinBtn.disabled = !(hasCoords && hasPhoto && hasName && hasId);
        }

        function getLocation() {
            locationStatus.textContent = 'æ­£åœ¨è·å–é«˜ç²¾åº¦å®šä½...';
            currentPosition = null;
            updateCheckinButtonState();

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentPosition = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude,
                            accuracy: position.coords.accuracy
                        };
                        locationStatus.textContent = 'âœ… å®šä½æˆåŠŸï¼';
                        coordsDisplay.textContent = `ç»åº¦: ${currentPosition.longitude.toFixed(6)}, çº¬åº¦: ${currentPosition.latitude.toFixed(6)} (ç²¾åº¦: ${currentPosition.accuracy.toFixed(2)}ç±³)`;
                        // è§¦å‘ä¸€æ¬¡åå‘åœ°ç†ç¼–ç è·å–åœ°å€ (éœ€è¦å€ŸåŠ©ç¬¬ä¸‰æ–¹æœåŠ¡æˆ–APIï¼Œä½†é™æ€éƒ¨ç½²ä¸­æˆ‘ä»¬çœç•¥è¿™ä¸€æ­¥ï¼Œä»…æ˜¾ç¤ºç»çº¬åº¦)
                        updateCheckinButtonState();
                    },
                    (error) => {
                        locationStatus.textContent = `âŒ å®šä½å¤±è´¥: ${error.message}`;
                        coordsDisplay.textContent = 'è¯·ç¡®ä¿æ‚¨å…è®¸æµè§ˆå™¨è®¿é—®å®šä½æƒé™ã€‚';
                        currentPosition = null;
                        updateCheckinButtonState();
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 0
                    }
                );
            } else {
                locationStatus.textContent = 'âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†å®šä½åŠŸèƒ½ã€‚';
            }
        }

        getLocationBtn.addEventListener('click', getLocation);

        // åˆå§‹åŒ–æ—¶è·å–ä¸€æ¬¡å®šä½
        getLocation();

        // ç›‘å¬è¾“å…¥æ¡†å˜åŒ–
        studentNameInput.addEventListener('input', updateCheckinButtonState);
        studentIdInput.addEventListener('input', updateCheckinButtonState);

        // =======================================================
        // 3. æ‹ç…§åŠŸèƒ½ (MediaDevices API)
        // =======================================================

        async function startCamera() {
            try {
                // ä¼˜å…ˆä½¿ç”¨åç½®/ç”¨æˆ·æ‘„åƒå¤´
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: { exact: "environment" } }, 
                    audio: false 
                });
            } catch (e) {
                try {
                    // å¦‚æœåç½®å¤±è´¥ï¼Œå°è¯•ä»»æ„æ‘„åƒå¤´
                    videoStream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: false 
                    });
                } catch (err) {
                    alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ã€‚è¯·æ£€æŸ¥æƒé™è®¾ç½®ã€‚');
                    console.error("Camera access error:", err);
                    return;
                }
            }
            video.srcObject = videoStream;
            video.play();
            takePhotoBtn.disabled = false;
            startCameraBtn.textContent = 'å…³é—­æ‘„åƒå¤´';
            startCameraBtn.classList.add('active'); // è§†è§‰æç¤ºæ‘„åƒå¤´å·²å¼€
            video.style.display = 'block';
            photoPreview.innerHTML = '';
            photoDataURL = null;
            updateCheckinButtonState();
        }

        function stopCamera() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            video.srcObject = null;
            takePhotoBtn.disabled = true;
            startCameraBtn.textContent = 'å¼€å¯æ‘„åƒå¤´';
            startCameraBtn.classList.remove('active');
            video.style.display = 'none';
        }

        startCameraBtn.addEventListener('click', () => {
            if (videoStream) {
                stopCamera();
            } else {
                startCamera();
            }
        });

        takePhotoBtn.addEventListener('click', () => {
            if (!videoStream) return;

            // è®¾ç½® Canvas å¤§å°ä¸ Video å…ƒç´ ä¿æŒä¸€è‡´
            photoCanvas.width = video.videoWidth;
            photoCanvas.height = video.videoHeight;
            const context = photoCanvas.getContext('2d');
            
            // å°†è§†é¢‘å¸§ç»˜åˆ¶åˆ° Canvas ä¸Š
            context.drawImage(video, 0, 0, photoCanvas.width, photoCanvas.height);
            
            // å¯¼å‡ºä¸º Data URL (JPEG æ ¼å¼)
            photoDataURL = photoCanvas.toDataURL('image/jpeg');
            
            // æ˜¾ç¤ºé¢„è§ˆ
            photoPreview.innerHTML = `<strong>ğŸ“· ç…§ç‰‡é¢„è§ˆ:</strong><img src="${photoDataURL}" class="preview-img" alt="ç­¾åˆ°ç…§ç‰‡">`;

            // æ‹ç…§ååœæ­¢æ‘„åƒå¤´ï¼ŒèŠ‚çœèµ„æº
            stopCamera();
            updateCheckinButtonState();
        });

        // =======================================================
        // 4. ç­¾åˆ°å’Œæ•°æ®å­˜å‚¨ (localStorage)
        // =======================================================

        const STORAGE_KEY = 'checkinData';

        function loadCheckinData() {
            const data = localStorage.getItem(STORAGE_KEY);
            try {
                return data ? JSON.parse(data) : [];
            } catch (e) {
                console.error("Failed to parse checkin data from localStorage:", e);
                return [];
            }
        }

        function saveCheckinData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        checkinBtn.addEventListener('click', () => {
            if (checkinBtn.disabled) return;

            const name = studentNameInput.value.trim();
            const id = studentIdInput.value.trim();

            if (!name || !id || !currentPosition || !photoDataURL) {
                alert('è¯·å¡«å†™å§“åå­¦å·ã€è·å–å®šä½å¹¶æ‹ç…§åå†ç­¾åˆ°ï¼');
                return;
            }

            const checkinRecord = {
                name: name,
                id: id,
                timestamp: new Date().toLocaleString('zh-CN'),
                latitude: currentPosition.latitude,
                longitude: currentPosition.longitude,
                accuracy: currentPosition.accuracy,
                photo: photoDataURL // Base64 ç¼–ç çš„å›¾ç‰‡æ•°æ®
            };

            const data = loadCheckinData();
            data.push(checkinRecord);
            saveCheckinData(data);

            checkinMessage.textContent = `ç­¾åˆ°æˆåŠŸï¼æ—¶é—´: ${checkinRecord.timestamp}`;
            
            // é‡ç½®çŠ¶æ€
            currentPosition = null;
            photoDataURL = null;
            photoPreview.innerHTML = '';
            studentNameInput.value = '';
            studentIdInput.value = '';
            updateCheckinButtonState();
            getLocation();
        });

        // =======================================================
        // 5. æ•™å¸ˆç«¯åŠŸèƒ½ï¼šæ•°æ®æ˜¾ç¤ºã€å¯¼å…¥å’Œå¯¼å‡º
        // =======================================================

        function renderCheckinList(data = loadCheckinData()) {
            checkinListBody.innerHTML = '';
            
            if (data.length === 0) {
                checkinListBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">æš‚æ— ç­¾åˆ°è®°å½•</td></tr>';
                return;
            }

            data.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)); // æŒ‰æ—¶é—´å€’åº

            data.forEach(record => {
                const row = checkinListBody.insertRow();
                row.insertCell().textContent = record.name;
                row.insertCell().textContent = record.id;
                row.insertCell().textContent = record.timestamp;
                row.insertCell().textContent = `${record.latitude.toFixed(6)}, ${record.longitude.toFixed(6)} (${record.accuracy.toFixed(1)}m)`;
                
                // å‡è®¾æ²¡æœ‰åå‘åœ°ç†ç¼–ç æœåŠ¡ï¼Œä½ç½®å­—æ®µç•™ç©ºæˆ–æ˜¾ç¤ºé€šç”¨ä¿¡æ¯
                row.insertCell().textContent = 'éœ€åœ°å›¾æœåŠ¡è§£æ';

                // ç…§ç‰‡é¢„è§ˆ
                const imgCell = row.insertCell();
                const img = document.createElement('img');
                img.src = record.photo;
                img.alt = 'ç­¾åˆ°ç…§ç‰‡';
                img.className = 'preview-img';
                imgCell.appendChild(img);
            });
        }

        // --- å¯¼å‡ºæ•°æ® ---
        exportDataBtn.addEventListener('click', () => {
            const data = loadCheckinData();
            if (data.length === 0) {
                alert('æœ¬åœ°æš‚æ— ç­¾åˆ°æ•°æ®å¯å¯¼å‡ºï¼');
                return;
            }
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `checkin_data_${new Date().toLocaleDateString('zh-CN').replace(/\//g, '-')}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        // --- å¯¼å…¥æ•°æ® ---
        importDataFile.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('å¯¼å…¥æ–‡ä»¶æ ¼å¼ä¸æ­£ç¡®ï¼ŒæœŸæœ›ä¸€ä¸ª JSON æ•°ç»„ã€‚');
                    }
                    
                    // å°†å¯¼å…¥çš„æ•°æ®åˆå¹¶åˆ°ç°æœ‰æ•°æ®ä¸­ (å¯ä»¥æ ¹æ®IDå’Œæ—¶é—´æˆ³å»é‡ï¼Œè¿™é‡Œä¸ºç®€åŒ–ç›´æ¥åˆå¹¶)
                    let currentData = loadCheckinData();
                    // ç®€å•çš„è¿½åŠ åˆå¹¶
                    const combinedData = currentData.concat(importedData.filter(
                        // ç®€å•æ£€æŸ¥å¯¹è±¡ç»“æ„
                        item => item.name && item.id && item.timestamp
                    )); 
                    
                    // å»é‡ (åŸºäº name + id + timestamp)
                    const uniqueDataMap = new Map();
                    combinedData.forEach(item => {
                        const key = `${item.id}-${item.timestamp}`;
                        if (!uniqueDataMap.has(key)) {
                            uniqueDataMap.set(key, item);
                        }
                    });

                    saveCheckinData(Array.from(uniqueDataMap.values()));

                    alert(`æ•°æ®å¯¼å…¥æˆåŠŸï¼å…±å¯¼å…¥/åˆå¹¶ ${Array.from(uniqueDataMap.values()).length} æ¡è®°å½•ã€‚`);
                    renderCheckinList();
                } catch (error) {
                    alert(`å¯¼å…¥å¤±è´¥: ${error.message}`);
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        });

        // --- æ¸…ç©ºæ•°æ® ---
        clearDataBtn.addEventListener('click', () => {
            if (confirm('âš ï¸ è­¦å‘Šï¼šæ‚¨ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°ç­¾åˆ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                localStorage.removeItem(STORAGE_KEY);
                alert('æœ¬åœ°ç­¾åˆ°æ•°æ®å·²æ¸…ç©ºã€‚');
                renderCheckinList();
            }
        });

        // =======================================================
        // 6. åˆå§‹åŒ–
        // =======================================================

        setView('student'); // é»˜è®¤æ˜¾ç¤ºå­¦ç”Ÿç«¯

    </script>
</body>
</html>
